<!--{subtemplate common/header_common}-->
	<meta name="application-name" content="$_G['setting']['bbname']" />
	<meta name="msapplication-tooltip" content="$_G['setting']['bbname']" />
	<!--{if $_G['setting']['portalstatus']}--><meta name="msapplication-task" content="name=$_G['setting']['navs'][1]['navname'];action-uri={echo !empty($_G['setting']['domain']['app']['portal']) ? 'http://'.$_G['setting']['domain']['app']['portal'] : $_G[siteurl].'portal.php'};icon-uri={$_G[siteurl]}{IMGDIR}/portal.ico" /><!--{/if}-->
	<meta name="msapplication-task" content="name=$_G['setting']['navs'][2]['navname'];action-uri={echo !empty($_G['setting']['domain']['app']['forum']) ? 'http://'.$_G['setting']['domain']['app']['forum'] : $_G[siteurl].'forum.php'};icon-uri={$_G[siteurl]}{IMGDIR}/bbs.ico" />
	<!--{if $_G['setting']['groupstatus']}--><meta name="msapplication-task" content="name=$_G['setting']['navs'][3]['navname'];action-uri={echo !empty($_G['setting']['domain']['app']['group']) ? 'http://'.$_G['setting']['domain']['app']['group'] : $_G[siteurl].'group.php'};icon-uri={$_G[siteurl]}{IMGDIR}/group.ico" /><!--{/if}-->
	<!--{if helper_access::check_module('feed')}--><meta name="msapplication-task" content="name=$_G['setting']['navs'][4]['navname'];action-uri={echo !empty($_G['setting']['domain']['app']['home']) ? 'http://'.$_G['setting']['domain']['app']['home'] : $_G[siteurl].'home.php'};icon-uri={$_G[siteurl]}{IMGDIR}/home.ico" /><!--{/if}-->
	<!--{if $_G['basescript'] == 'forum' && $_G['setting']['archiver']}-->
		<link rel="archives" title="$_G['setting']['bbname']" href="{$_G[siteurl]}archiver/" />
	<!--{/if}-->
	<!--{if !empty($rsshead)}-->$rsshead<!--{/if}-->
	<!--{if widthauto()}-->
		<link rel="stylesheet" id="css_widthauto" type="text/css" href='{$_G['setting']['csspath']}{STYLEID}_widthauto.css?{VERHASH}' />
		<script type="text/javascript">HTMLNODE.className += ' widthauto'</script>
	<!--{/if}-->
	<!--{if $_G['basescript'] == 'forum' || $_G['basescript'] == 'group'}-->
		<script type="text/javascript" src="{$_G[setting][jspath]}forum.js?{VERHASH}"></script>
	<!--{elseif $_G['basescript'] == 'home' || $_G['basescript'] == 'userapp'}-->
		<script type="text/javascript" src="{$_G[setting][jspath]}home.js?{VERHASH}"></script>
	<!--{elseif $_G['basescript'] == 'portal'}-->
		<script type="text/javascript" src="{$_G[setting][jspath]}portal.js?{VERHASH}"></script>
	<!--{/if}-->
	<!--{if $_G['basescript'] != 'portal' && $_GET['diy'] == 'yes' && check_diy_perm($topic)}-->
		<script type="text/javascript" src="{$_G[setting][jspath]}portal.js?{VERHASH}"></script>
	<!--{/if}-->
	<!--{if $_GET['diy'] == 'yes' && check_diy_perm($topic)}-->
		<link rel="stylesheet" type="text/css" id="diy_common" href="{$_G['setting']['csspath']}{STYLEID}_css_diy.css?{VERHASH}" />
	<!--{/if}-->
	<meta charset="utf-8" />
	<link rel="stylesheet" href="./template/EnglishDB/common/css/global.css" ／>
	<link rel="stylesheet" href="./template/EnglishDB/common/css/main.css" ／>
	<link rel="stylesheet" href="./template/EnglishDB/common/css/personalEdit.css" ／>

	<script type="text/javascript" src="./template/EnglishDB/common/js/jquery.min.js"></script>
	<script>
		jq = jQuery.noConflict();
	</script>
</head>
<body id="nv_{$_G[basescript]}" class="pg_{CURMODULE}{if $_G['basescript'] === 'portal' && CURMODULE === 'list' && !empty($cat)} {$cat['bodycss']}{/if}" onkeydown="if(event.keyCode==27) return false;">

	<script>
		function GetQueryString(name) {
		    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
		    var r = window.location.search.substr(1).match(reg);
		    if(r!=null)return  unescape(r[2]); return null;
		}

		function myAjax(){ 
			var ajaxData = { 
				type:arguments[0].type || "GET", 
				url:arguments[0].url || "", 
				async:arguments[0].async || "true", 
				data:arguments[0].data || null, 
				dataType:arguments[0].dataType || "text", 
				contentType:arguments[0].contentType || "application/x-www-form-urlencoded", 
				beforeSend:arguments[0].beforeSend || function(){}, 
				success:arguments[0].success || function(){}, 
				error:arguments[0].error || function(){}
			} 
			ajaxData.beforeSend() 
			var xhr = createxmlHttpRequest();  
			xhr.responseType=ajaxData.dataType; 
			xhr.open(ajaxData.type,ajaxData.url,ajaxData.async);  
			xhr.setRequestHeader("Content-Type",ajaxData.contentType);  
			xhr.send(convertData(ajaxData.data));  
			xhr.onreadystatechange = function() {  
				if (xhr.readyState == 4) {  
					if(xhr.status == 200) { 
						ajaxData.success(xhr.response) 
					}
					else { 
						ajaxData.error() 
					}
				}
			}  
		} 
		function createxmlHttpRequest() {  
			if (window.ActiveXObject) {  
				return new ActiveXObject("Microsoft.XMLHTTP");  
			} else if (window.XMLHttpRequest) {  
				return new XMLHttpRequest();  
			}  
		}
		function convertData(data){ 
			if( typeof data === 'object' ) { 
				var convertResult = "" ;  
				for(var c in data) {  
					convertResult+= c + "=" + data[c] + "&";  
				}  
				convertResult=convertResult.substring(0,convertResult.length-1) 
				return convertResult; 
			}
			else { 
				return data; 
			} 
		}

		jq(document).ready(function() {

			//choose personalModule
			var targetPml;
			if(window.location.pathname.indexOf("home.php")!=-1) {
				var pmlmod = GetQueryString("mod");
				var pmldo = GetQueryString("do");

				if(pmlmod == "space" && pmldo == "favorite") {
					targetPml = jq("#pModule1");
				}
				else if(pmlmod == "space" && pmldo == "pm") {
					targetPml = jq("#pModule2");
				}
				else if(pmlmod == "spacecp") {
					targetPml = jq("#pModule3");
				}
				else if(pmlmod == "space" && pmldo == "friend") {
					targetPml = jq("#pModule4");
				}
				else targetPml = jq("#pModule0");
			}
			else {
				targetPml = jq("#pModule0");
			}
			if(targetPml.length > 0) {
				targetPml.addClass("choose");
				targetPml.find(".arrow").eq(0).addClass("arrowChoose");
				targetPml.attr("onclick","");
			}
		});

	</script>
	<!--{if $_G['uid']}-->
	<script>
		curTalkId = "";
		firstFlag = 0;
		curFriendId = "";

		function getChatDetail(uname, fuid, isNew, plid) {
			var obj = jq("#friend"+fuid);
			if(!plid) {
				plid = "";
			}
			curTalkId = plid;
			curFriendId = fuid;
			//alert(fuid+" "+plid);
			if(isNew != null && isNew == 1) {
				obj.attr("onclick","getChatDetail('"+uname+"', '"+fuid+"', 0, '"+plid+"')");
				obj.find(".isNew").eq(0).remove();
				myAjax({
					url:'./updateIsNewMes.php',
					type:'post',
					data:'fuid='+fuid+'&plid='+plid
				});
			}

			jq("#chatName").html(uname);

			myAjax({
				url:'./fetchChatDetail.php',
				type:'post',
				data:'fuid='+fuid+'&plid='+plid,
				error: function () {
					alert("error");
				},
				success: function (data) {
					//alert(data);
					var jsonObj = JSON.parse(data);
					var cc = jq("#chatContent");
					cc.empty();
					for(var i = 0; i < jsonObj.length; i++) {
						var tri = "rightTri";
						var mymes = " myMes";
						var grey = " grey";
						if(jsonObj[i].authorid == fuid) {
							tri = "leftTri";
							mymes = "";
							grey = "";
						}
						cc.append('<div class="chatMessage'+mymes+'"><div class="friendPic">'+
							'<img src="uc_server/avatar.php?uid='+jsonObj[i].authorid+
							'&size=small" /></div><div class="'+tri+'"></div><div class="'+
							'mesContent'+grey+'">'+jsonObj[i].message+'</div></div>');
					}
					cc.scrollTop(cc[0].scrollHeight);
				}
			});
		}

		function showChatBox() {
			if(firstFlag == 0) {
				firstFlag = 1;
				var fl = jq("#friendList").find(".item");
				if(fl.length > 0) {
					fl.eq(0).trigger("click");
				}
			}
			jq("#chatEntry").hide();
			jq("#chatBox").show();
		}
		function hideChatBox() {
			jq("#chatBox").hide();
			jq("#chatEntry").show();
		}

		jq(document).ready(function() {
			//load chat module
			myAjax({
				url:'./fetchChatFriendsList.php',     
				type:'get',
				error: function() {     
					alert('error');     
				},
				success: function(data) {
					//alert(data);
					var jsonObj = JSON.parse(data);
					var fl = jq("#friendList");
					var newCnt = 0;
					for(var i = 0; i < jsonObj.length; i++) {
						if(jsonObj[i].name == null || jsonObj[i].name == "") continue;
						var isNewContent = "";
						if(jsonObj[i].isnew != null && jsonObj[i].isnew == "1") {
							isNewContent = '<div class="isNew"><div class="text">New</div><div class="dot"></div></div>';
							newCnt++;			
						}
						fl.append('<div class="item" id="friend'+jsonObj[i].fuid+'" onclick="getChatDetail(\''+jsonObj[i].name+'\',\''+jsonObj[i].fuid+'\','+jsonObj[i].isnew+',\''+jsonObj[i].plid+'\')">'+
							'<div class="friendPic"><img src="'+
							'uc_server/avatar.php?uid='+jsonObj[i].fuid+'&size=small" /></div>'+
							'<div class="friendName">'+jsonObj[i].name+'</div>'+
							isNewContent + '</div>');
					}
					if(newCnt > 0) {
						jq("#chatEntry").html('message('+newCnt+' new)');
					}
				}
			});
			jq(document).click(function(){
    			hideChatBox();
			});
			jq("#chatBox").click(function(event){
    			event.stopPropagation();
			});
			jq("#chatEntry").click(function(event){
    			event.stopPropagation();
			});
		});
	</script>
	<!--{/if}-->

	<div id="append_parent"></div>
	<div id="ajaxwaitid"></div>

	<div class="sideBar">


		<div class="forumLogo"><img src="./template/EnglishDB/common/img/logo.png" /></div>
		<!--{if $_G['uid']}-->
		<div class="personalInfo">
				
			<div class="pPhoto"><a href="home.php?mod=space&uid=$_G[uid]"><!--{avatar($_G[uid],big)}--></a></div>
			<div class="name">{$_G[member][username]}</div>
			<div class="pInfo" id="grade">
				<a class="pInfo" href="home.php?mod=spacecp&ac=credit&showcredit=1">grade: $_G[member][credits]</a>
			</div>
			<div class="pInfo" id="article">article: *</div>			
		</div>

		<div class="personalModuleList" id="personalModuleList">
			<div class="personalModule" id="pModule0" onclick="window.location.href='forum.php'">
				<img src="./template/EnglishDB/common/img/arrow.png" class="arrow" /><img src="./template/EnglishDB/common/img/homepage.png" class="personalModuleTitle" />
			</div>
			<div class="personalModule" id="pModule1" onclick="window.location.href='home.php?mod=space&do=favorite&view=me'">
				<img src="./template/EnglishDB/common/img/arrow.png" class="arrow" /><img src="./template/EnglishDB/common/img/favorites.png" class="personalModuleTitle" />
			</div>
			<div class="personalModule" id="pModule2" onclick="window.location.href='home.php?mod=space&do=pm'">
				<img src="./template/EnglishDB/common/img/arrow.png" class="arrow" /><img src="./template/EnglishDB/common/img/mail2.png" class="personalModuleTitle" />
			</div>
			<div class="personalModule" id="pModule3" onclick="window.location.href='home.php?mod=spacecp'">
				<img src="./template/EnglishDB/common/img/arrow.png" class="arrow" /><img src="./template/EnglishDB/common/img/settings.png" class="personalModuleTitle" /><
			</div>
			<div class="personalModule" id="pModule4" onclick="window.location.href='home.php?mod=space&do=friend'">
				<img src="./template/EnglishDB/common/img/arrow.png" class="arrow" /><img src="./template/EnglishDB/common/img/friends.png" class="personalModuleTitle" />
			</div>
			<div class="personalModule" id="pModule5">
				<a href="member.php?mod=logging&action=logout&formhash={FORMHASH}">{lang logout}</a>
			</div>
		</div>
		
		<!--{else}-->
			<!--{template member/login_simple}-->
		<!--{/if}-->

	</div>

	<!--{if $_G['uid']}-->
	<div class="chatModule">
		<div class="chatEntry" id="chatEntry" onclick="showChatBox()">message</div>
		<div class="chatB" id="chatBox">
			<div class="chatBox">
				<div class="friend">
					<input type="text" placeholder="search friend" class="findFriend" />
					<div class="horizenHr"></div>
					<div class="friendList" id="friendList">
						<!--
						<div class="item">
							<div class="friendPic"><img src="" /></div>
							<div class="friendName">zoudm</div>
						</div>
						-->
					</div>
				</div>
				<div class="verticleHr"></div>
				<div class="chatList">
					<div class="chatTop">
						<div id="chatName"></div>
						<img src="./template/EnglishDB/common/img/false.png" class="close" onclick="hideChatBox()" />
					</div>
					<div class="horizenHr"></div>
					<div class="chatContent" id="chatContent">
						<!--
						<div class="chatMessage myMes">
							<div class="friendPic"><img src="" /></div>
							<div class="rightTri"></div>
							<div class="mesContent grey">hello</div>
						</div>
						-->
					</div>
					<div class="horizenHr"></div>
					<div class="chatInputLine">
						<input type="text" class="chatInput" />
						<div class="verticleHr"></div>
						<div class="emoji"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--{/if}-->
	
